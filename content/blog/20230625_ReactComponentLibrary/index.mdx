---
title: è®°å½•ä¸€æ¬¡ä»é›¶å¼€å§‹çš„Reactç»„ä»¶åº“é¡¹ç›®
date: '2023-06-25T20:00:00'
description: React+TypeScript+Sasså‰ç«¯ç»„ä»¶åº“é¡¹ç›®æµç¨‹è®°å½•
tag: ['FE']
---

import after1 from './after1.jpg'
import after2 from './after2.jpg'
import prev from './prev.jpg'
import select1 from './select1.jpg'
import select2 from './select2.jpg'
import select3 from './select3.jpg'
import storybook1 from './storybook1.jpg'
import storybook2 from './storybook2.jpg'
import storybook3 from './storybook3.jpg'

é¡¹ç›®åœ°å€ï¼šhttps://github.com/Russellwzr/russell-react-ui

## æ•´ä½“æµç¨‹

1. é¡¹ç›®ç»“æ„å’Œä»£ç è§„èŒƒ
2. æ ·å¼è§£å†³æ–¹æ¡ˆ
3. ç»„ä»¶éœ€æ±‚åˆ†æåŠå®ç°
4. æµ‹è¯•ç”¨ä¾‹åˆ†æåŠå®ç°
5. ç»„ä»¶åº“è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ
6. npm æ‰“åŒ…å‘å¸ƒåŠæ–‡æ¡£ç½‘ç«™éƒ¨ç½²

## ä¸€ã€é¡¹ç›®ç»“æ„å’Œä»£ç è§„èŒƒ

### æ–‡ä»¶ç»“æ„è®¾ç½®

```
russell-react-ui/
  .github/
  .husky/
  .storybook/
  .prettierrc
  node_modules/
  README.md
  package.json
  package-lock.json
  tsconfig.json
  tsconfig.build.json
  src/
    hooks/
      ......
    components/
      Button/
        button.tsx
        button.test.tsx
        button.stories.tsx
        style.scss
      ......
    styles/
      _variables.scss (å„ç§å˜é‡ä»¥åŠå¯é…ç½®è®¾ç½®)
      _mixins.scss (å…¨å±€ mixins)
      _reboot.scss (normalize.css)
      _functions.scss (å…¨å±€ functions)
    index.tsx
```

### ä»£ç è§„èŒƒé…ç½®

#### ESLint

```
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ],
    "plugins": [
      "react-hooks"
    ],
    "rules": {
      "react-hooks/rules-of-hooks": "error",
      "react-hooks/exhaustive-deps": "warn"
    }
  }
```

#### Prettier

```
  {
    "singleQuote": true,
    "trailingComma": "all",
    "printWidth": 120,
    "bracketSpacing": true,
    "semi": false,
    "tabWidth": 2,
    "jsxSingleQuote": false,
    "overrides": [
      {
        "files": ".prettierrc",
        "options": { "parser": "json" }
      }
    ],
    "endOfLine": "auto"
  }
```

#### Husky

```
  npm install husky --save-dev

  // å¼€å¯ git hooks
  npx husky install
  npm pkg set scripts.prepare="husky install"

  // è®¾ç½®æ¯æ¬¡git commitå‰è‡ªåŠ¨è¿è¡Œç»„ä»¶æµ‹è¯•ä»¥åŠeslintä»£ç æ£€æŸ¥
  npx husky add .husky/pre-commit "npm run test:nowatch && npm run lint"
  git add .husky/pre-commit
```

## äºŒã€æ ·å¼è§£å†³æ–¹æ¡ˆ

- é€‰å–äº† SCSS ä½œä¸ºæ ·å¼è§£å†³æ–¹æ¡ˆ

  - æ ·å¼è§£å†³æ–¹æ¡ˆåˆ†æå¯è§ä¹‹å‰æ–‡ç« ï¼š[React é¡¹ç›®æ ·å¼è§£å†³æ–¹æ¡ˆæ‚è°ˆ](https://russellwzr.github.io/blog/20230606_ReactStyles/)

- æ ·å¼ç›¸å…³æ–‡ä»¶ç»“æ„

  ```
  styles/
    _variables.scss (å„ç§å˜é‡ä»¥åŠå¯é…ç½®è®¾ç½®)
    _mixins.scss (å…¨å±€ mixins)
    _functions.scss (å…¨å±€ functions)
    _reboot.scss (normalize.css)
  components/
    Button/
      style.scss (ç»„ä»¶å•ç‹¬çš„æ ·å¼)
      ...
  ```

- è‰²å½©ç³»ç»Ÿ

  - ç³»ç»Ÿè‰²æ¿ï¼šåŸºç¡€è‰²æ¿ + ä¸­æ€§è‰²æ¿
  - äº§å“è‰²æ¿ï¼šå“ç‰Œè‰²æ¿ + åŠŸèƒ½è‰²æ¿

- å­—ä½“ç³»ç»Ÿï¼ˆè®¾ç½® font-family, font-size, font-weight ......ï¼‰

- æ·»åŠ  normalize.cssï¼ˆä¿®æ”¹ä¸º \_reboot.scss å¹¶èåˆ \_variables.scss é‡Œçš„å˜é‡è®¾ç½®ï¼‰

## ä¸‰ã€ç»„ä»¶éœ€æ±‚åˆ†æåŠå®ç°

è¯¥éƒ¨åˆ†é€‰å–äº† Form ä»¥åŠ Select ç»„ä»¶è¿›è¡Œè®°å½•ï¼Œåªä»‹ç»ä¸»è¦çš„åˆ†æä¸è®¾è®¡æµç¨‹ï¼Œå…·ä½“å®ç°å¯å‚è§ä»“åº“æºç ã€‚

### Form Component

#### 1. ä¸»ä½“åŠŸèƒ½åˆ†æ

- é»˜è®¤è®¾ç½®ï¼šæ”¯æŒåœ¨è¡¨å•é¡¶å±‚è®¾ç½®å„ä¸ªè¡¨å•å…ƒç´ çš„é»˜è®¤å€¼ï¼Œä»¥æ–¹ä¾¿æç¤ºåŠé‡ç½®

- çµæ´»æ¸²æŸ“ï¼šæ—¢å¯ä»¥è‡ªè¡Œå†³å®šå­å…ƒç´ èŠ‚ç‚¹çš„é€‰å–ï¼Œè¿˜å¯ä»¥ç»“åˆè¡¨å•çŠ¶æ€å®šåˆ¶æ¸²æŸ“ç»“æœ
- è§„åˆ™éªŒè¯ï¼šæ”¯æŒè‡ªå®šä¹‰è§„åˆ™ã€å¤šé¡¹è§„åˆ™æ ¡éªŒã€è‡ªå®šä¹‰éªŒè¯æ—¶æœºã€è¡¨å•æ•´ä½“éªŒè¯
- å®ä¾‹è·å–ï¼šç”¨æˆ·å¯ä»¥ç›´æ¥è·å–è¡¨å•çš„çŠ¶æ€åŠæ–¹æ³•æ¥æ›´åŠ æ–¹ä¾¿åœ°å®ç°å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚

#### 2. ç»„ä»¶ç»“æ„è®¾è®¡

é‡‡å– Form+FormItem çš„å±‚çº§ç»“æ„ï¼Œä»¥çµæ´»æ”¯æŒ UI è‡ªå®šä¹‰ï¼ˆant-design, arco-design ç­‰ç»„ä»¶åº“éƒ½ä½¿ç”¨äº†è¯¥æ–¹å¼ï¼‰

```tsx
<Form>
  <FormItem label="Username">
    <Input placeholder="please enter your username..." />
  </FormItem>
  <FormItem label="Post">
    <Input placeholder="please enter your post..." />
  </FormItem>
  <FormItem>
    <Checkbox>I have read the manual</Checkbox>
  </FormItem>
  <FormItem>
    <Button type="primary">Submit</Button>
  </FormItem>
</Form>
```

ç»“åˆä¸Šè¿°åŠŸèƒ½éœ€æ±‚ï¼Œä¸¤ä¸ªç»„ä»¶çš„å±æ€§è®¾è®¡å¦‚ä¸‹ï¼š

```tsx
/**
 * Form Component
 */
/** Custom Rendering */
export type RenderProps = (form: FormState) => ReactNode
export interface FormProps {
  /** Prefix of the form field */
  name?: string
  /** Default values for initialization and reset */
  initialValues?: Record<string, any>
  /** Callback function after the form is submitted and the data validation is successful */
  onFinish?: (values: Record<string, any>) => void
  /** Callback function after the form is submitted and the data validation fails */
  onFinishFailed?: (values: Record<string, any>, errors: Record<string, ValidateError[]>) => void
  children?: ReactNode | RenderProps
}

/**
 * FormItem Component
 */
export interface FormItemProps {
  /** Field name */
  name: string
  /** Label content */
  label?: string
  /** Attribute of the value of the child node, e.g. 'type=checkbox' is 'checked' */
  valuePropName?: string
  /** Set how to trigger value changes, e.g. onChange */
  trigger?: string
  /** Set how to get field value from event, e.g. e.target.value */
  getValueFromEvent?: (event: any) => any
  /** Validation rules (see async-validator for more details) */
  rules?: CustomRule[]
  /** Set the timing of field validation */
  validateTrigger?: string
  children?: ReactNode
}
```

#### 3. ç»„ä»¶çŠ¶æ€ç®¡ç†

ç”±ä¸Šè¿°åˆ†æå¯ä»¥çœ‹å‡ºï¼Œéœ€æ±‚ä¸­çš„éƒ¨åˆ†åŠŸèƒ½ï¼Œå¦‚â€œè¡¨å•æ•´ä½“éªŒè¯â€ï¼Œéœ€è¦ Form ç»„ä»¶ç»“åˆ FormItem ç»„ä»¶çš„ç›¸å…³çŠ¶æ€è¿›è¡Œå¤„ç†ï¼Œè€Œè¿™ä¸¤ç§ç»„ä»¶ä¹‹é—´å­˜åœ¨ç€å±‚çº§å…³ç³»ä¸” Form é‡‡ç”¨ children çš„æ–¹å¼æ¸²æŸ“ FormItemï¼ŒçŠ¶æ€ä¼ é€’çš„å®ç°è¾ƒä¸ºå¤æ‚ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨ Context æ¥å°†ä¸¤ç§ç»„ä»¶çš„çŠ¶æ€è¿›è¡Œå…±äº«ï¼Œå¹¶å€ŸåŠ© useReducer æ¥å®ç°çŠ¶æ€æ›´æ–°ã€‚

å…±äº«çŠ¶æ€å±æ€§è®¾ç½®ï¼š

- è¡¨å•æ•´ä½“çŠ¶æ€ FormStateï¼ŒåŒ…å«è¡¨å•æ˜¯å¦åˆæ³•ã€æ˜¯å¦æäº¤ä»¥åŠè§„åˆ™éªŒè¯è¿”å›çš„é”™è¯¯ä¿¡æ¯

  ```tsx
  export interface FormState {
    isValid: boolean
    isSubmitting: boolean
    errors: Record<string, ValidateError[]>
  }
  ```

- è¡¨å•å…ƒç´ çŠ¶æ€ FieldDetailï¼ŒåŒ…å«åç§°ã€å€¼ã€è‡ªå®šä¹‰è§„åˆ™ã€æ˜¯å¦åˆæ³•ä»¥åŠè§„åˆ™éªŒè¯è¿”å›çš„é”™è¯¯ä¿¡æ¯

  ```tsx
  export interface FieldDetail {
    name: string
    value: string
    rules: CustomRule[]
    isValid: boolean
    errors: ValidateError[]
  }

  export interface FieldsState {
    [key: string]: FieldDetail
  }
  ```

çŠ¶æ€æ›´æ–°ç›¸å…³ actionï¼š

- addField æ·»åŠ è¡¨å•å…ƒç´ ï¼ŒupdateValue æ›´æ–°è¡¨å•å…ƒç´ ï¼ŒupdateValidateResult æ›´æ–°æ ¡éªŒç»“æœ

  ```tsx
  export interface FieldsAction {
    type: 'addField' | 'updateValue' | 'updateValidateResult'
    name: string
    value: any
  }

  function fieldsReducer(state: FieldsState, action: FieldsAction): FieldsState {
    switch (action.type) {
      case 'addField':
        return {
          ...state,
          [action.name]: { ...action.value },
        }
      case 'updateValue':
        return {
          ...state,
          [action.name]: { ...state[action.name], value: action.value },
        }
      case 'updateValidateResult':
        const { isValid, errors } = action.value
        return {
          ...state,
          [action.name]: { ...state[action.name], isValid, errors },
        }
      default:
        return state
    }
  }
  ```

#### 4. ç»„ä»¶åŠŸèƒ½å®ç°

è¿™é‡Œåªè´´äº†éƒ¨åˆ†æµç¨‹é€»è¾‘ï¼Œå…·ä½“å®ç°å¯å‚è§ä»“åº“æºç 

- åˆå§‹åŒ– Store

  ```tsx
  // form.tsx
  const { name, initialValues, onFinish, onFinishFailed, children } = props
  const { form, fields, dispatch, ...restProps } = useStore(initialValues)
  const { validateField, validateAllFields } = restProps
  const passedContext: IFormContext = {
    dispatch,
    fields,
    validateField,
    initialValues,
  }
  ```

- ç»“åˆè¡¨å•çŠ¶æ€å®šåˆ¶è¡¨å•å…ƒç´ æ¸²æŸ“

  ```tsx
  let childrenNode: ReactNode
  if (typeof children === 'function') {
    childrenNode = children(form)
  } else {
    childrenNode = children
  }

  return (
    <form name={name} className="form" onSubmit={submitForm}>
      <FormContext.Provider value={passedContext}>{childrenNode}</FormContext.Provider>
    </form>
  )
  ```

- åˆ›å»ºè¡¨å•å…ƒç´ ï¼šè·å–åˆå§‹å€¼ï¼Œè§¦å‘ addField æ“ä½œï¼Œå¹¶å€ŸåŠ© React.cloneElement å®ç°ç»„ä»¶å…ƒç´ è‡ªå®šä¹‰è®¾ç½®çš„æ³¨å…¥

  ```tsx
  // formItem.tsx

  /** Initialize the form content */
  useEffect(() => {
    const value = (initialValues && initialValues[name]) || ''
    dispatch({ type: 'addField', name, value: { label, name, value, rules: rules || [], errors: [], isValid: true } })
  }, [])

  /** Add the custom attributes to FormItem */
  const onValueUpdate = (e: any) => {
    const value = getValueFromEvent(e)
    dispatch({ type: 'updateValue', name, value })
  }
  const onValueValidate = async () => {
    await validateField(name)
  }
  const controlProps: Record<string, any> = {}
  controlProps[valuePropName] = value
  controlProps[trigger] = onValueUpdate
  if (rules) {
    controlProps[validateTrigger] = onValueValidate
  }
  const childList = React.Children.toArray(children)
  if (childList.length === 0) {
    throw new Error('No child element found in Form.Item, please provide one form component')
  }
  if (childList.length > 1) {
    console.warn('Only support one child element in Form.Item, others will be omitted')
  }
  if (!React.isValidElement(childList[0])) {
    throw new Error('Child component is not a valid React Element')
  }
  const child = childList[0] as React.ReactElement
  const customChildNode = React.cloneElement(child, { ...child.props, ...controlProps })
  ```

- è‡ªå®šä¹‰è§„åˆ™åŠè§„åˆ™éªŒè¯

  ```tsx
  const transfromRules = (rules: CustomRule[]) => {
    return rules.map((rule) => {
      if (typeof rule === 'function') {
        const calledRule = rule({ getFieldValue })
        return calledRule
      } else {
        return rule
      }
    })
  }

  const validateField = async (name: string) => {
    const { value, rules } = fields[name]
    const afterRules = transfromRules(rules)
    const descriptor = {
      [name]: afterRules,
    }
    const valueMap = {
      [name]: value,
    }
    const validator = new Schema(descriptor)
    let isValid = true
    let errors: ValidateError[] = []
    try {
      await validator.validate(valueMap)
    } catch (e: any) {
      isValid = false
      errors = e.errors
    } finally {
      dispatch({ type: 'updateValidateResult', name, value: { isValid, errors } })
    }
  }

  const validateAllFields = async () => {
    let isValid = true
    let errors: Record<string, ValidateError[]> = {}
    const valueMap = mapValues(fields, (item) => item.value)
    const descriptor = mapValues(fields, (item) => transfromRules(item.rules))
    const validator = new Schema(descriptor)
    setForm({ ...form, isSubmitting: true })
    try {
      await validator.validate(valueMap)
    } catch (e) {
      isValid = false
      const err = e as ValidateErrorType
      errors = err.fields
      each(fields, (value, name) => {
        if (errors[name]) {
          const itemErrors = errors[name]
          dispatch({ type: 'updateValidateResult', name, value: { isValid: false, errors: itemErrors } })
        } else if (value.rules.length > 0 && !errors[name]) {
          dispatch({ type: 'updateValidateResult', name, value: { isValid: true, errors: [] } })
        }
      })
    } finally {
      setForm({ ...form, isSubmitting: false, isValid, errors })
      return {
        isValid,
        errors,
        values: valueMap,
      }
    }
  }
  ```

- forwardRef + useImperativeHandle æš´éœ²å®ä¾‹æ–¹æ³•

  ```tsx
  export const Form = forwardRef<IFormRef, FormProps>((props, ref) => {
    const { form, fields, dispatch, ...restProps } = useStore(initialValues)
    ......
    ......
    ......
    // forwardRef + useImperativeHandle to expose instance methods
    useImperativeHandle(ref, () => {
      return {
        ...restProps,
      }
    })
    ......
    ......
    ......
  })
  ```

### Select Component

Select ç»„ä»¶çš„éœ€æ±‚æ¯”è¾ƒç®€å•ï¼Œå³æ”¯æŒé€‰é¡¹çš„è‡ªå®šä¹‰ä»¥åŠå•é€‰å¤šé€‰ç­‰ï¼ŒæåŠå®ƒåªæ˜¯ä¸ºäº†å¼ºè°ƒåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸€å®šè¦æ³¨æ„è¾¹ç¼˜ caseï¼Œè¿™é‡Œä»¥å¤šé€‰æ¡†ä¸ºä¾‹ï¼Œå½“é€‰é¡¹è¿‡é•¿æˆ–è€…é€‰æ‹©çš„é€‰é¡¹è¿‡å¤šæ—¶ï¼Œå°±ä¼šå‡ºç°ä¸‹é¢è¿™ç§æƒ…å†µï¼š

<img src={select1} style={{ zoom: '67%', margin: '0 auto' }} />

é€‰é¡¹è¿‡é•¿å¯¼è‡´ tag æ¡†æº¢å‡ºï¼Œé€‰æ‹©çš„é€‰é¡¹è¿‡å¤šå¯¼è‡´ tag æ¡†æº¢å‡ºäº†é€‰æ‹©æ¡†ï¼Œä¸Šè¿°é—®é¢˜å¯ä»¥é€šè¿‡å®æ—¶è·å– tag æ¡†çš„é«˜åº¦å¹¶å¯¹å¤šé€‰æ¡†çš„é«˜åº¦è¿›è¡ŒåŠ¨æ€æ›´æ–°ä»¥åŠæº¢å‡ºæ ·å¼è°ƒæ•´æ¥è§£å†³ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

<img src={select2} style={{ zoom: '67%', margin: '0 auto' }} />

æ­¤å¤–ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹ä¼šç‰¹åˆ«å¤šï¼Œä¸ºäº†é˜²æ­¢ tag æ¡†çš„æ— é™å¢é«˜å¯¹é¡µé¢æ•´ä½“å¸ƒå±€çš„å½±å“ï¼Œè¿™é‡Œé¢å¤–è®¾ç½®äº†ä¸€ä¸ªè‡ªå®šä¹‰é€‰é¡¹ï¼Œè®©ç”¨æˆ·æ¥æ§åˆ¶é€‰æ‹©æ¡†ä¸­æ‰€æ˜¾ç¤ºçš„æ ‡ç­¾æ•°ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

<img src={select3} style={{ zoom: '67%', margin: '0 auto' }} />

## å››ã€æµ‹è¯•ç”¨ä¾‹åˆ†æåŠå®ç°

ä½¿ç”¨ Jest + React Testing Library è¿›è¡Œæµ‹è¯•ï¼Œé€šè¿‡ Jest æä¾›çš„æµ‹è¯•è¿è¡Œç¯å¢ƒå’Œæ–­è¨€åº“ä»¥åŠ React Testing Library åœ¨ react-dom å’Œ react-dom/test-utils ä¹‹ä¸Šæä¾›çš„è½»é‡çº§å‡½æ•°ï¼Œå¯ä»¥å®ç°æ›´åŠ æ¥è¿‘ç”¨æˆ·ä½¿ç”¨æ–¹å¼çš„æµ‹è¯•æµç¨‹ã€‚

è¿™é‡Œä»¥ Select ç»„ä»¶çš„ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸ºä¾‹ï¼Œè¿›è¡Œä»‹ç»ï¼Œæ•´ä¸ªæµ‹è¯•æµç¨‹å¦‚ä¸‹ï¼š

- è·å–é€‰æ‹©æ¡†å¯¹åº”çš„ dom å…ƒç´ ï¼Œç„¶åè§¦å‘ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
- è·å–æ‰€æœ‰é€‰é¡¹å¯¹åº”çš„ dom å…ƒç´ ï¼Œç„¶åä¾æ¬¡è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œé€‰ä¸­é€‰é¡¹
- æ£€æŸ¥ tag-items çš„æ•°ç›®ä»¥åŠé¢å¤–é€‰ä¸­çš„é€‰é¡¹æ•°æ˜¯å¦ç¬¦åˆé¢„æœŸ
- ......

ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ªæµ‹è¯•æµç¨‹å…¶å®å°±æ˜¯é€šè¿‡ç¨‹åºæ¥æ¨¡æ‹Ÿæµ‹è¯•äººå‘˜çš„æ‰‹åŠ¨æµ‹è¯•ï¼Œä»¥è‡ªåŠ¨åŒ–çš„æ–¹å¼æé«˜æµ‹è¯•çš„æ•ˆç‡ä¸å‡†ç¡®åº¦ã€‚

```tsx
it('Max Tag setting in multiple mode should works fine', () => {
  render(
    <Select {...multipleProps} maxTagCount={2}>
      <Option value="id1" label="first" />
      <Option value="id2" label="second" />
      <Option value="id3" label="third" />
      <Option value="id4" label="fourth" />
    </Select>,
  )
  const inputEle = screen.getByPlaceholderText('test') as HTMLInputElement
  fireEvent.click(inputEle)
  const firstItem = screen.getByText('first')
  const secondItem = screen.getByText('second')
  const thirdItem = screen.getByText('third')
  const fourthItem = screen.getByText('fourth')
  fireEvent.click(firstItem)
  fireEvent.click(secondItem)
  fireEvent.click(thirdItem)
  fireEvent.click(fourthItem)
  expect(screen.getAllByTestId('tag-items').length).toEqual(3)
  expect(screen.getByText('+ 2 ...')).toBeInTheDocument()
  fireEvent.click(fourthItem)
  expect(screen.getAllByTestId('tag-items').length).toEqual(3)
  expect(screen.getByText('+ 1 ...')).toBeInTheDocument()
  fireEvent.click(thirdItem)
  expect(screen.getAllByTestId('tag-items').length).toEqual(2)
})
```

Jest ä½¿ç”¨æ³¨æ„ï¼š

- Jest è¿è¡Œåœ¨ Node.js ç¯å¢ƒä¸Šï¼Œéµå¾ª CommonJS è§„èŒƒï¼Œä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œéœ€è¦å°†å¯¼å…¥å¯¼å‡ºæ¨¡å—ä» ES Module è§„èŒƒè½¬ä¸º CommonJS è§„èŒƒï¼Œè€Œ Jest é»˜è®¤å¿½ç•¥/node_modules/ç›®å½•çš„è½¬æ¢ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æŠŠå¼•ç”¨æŠ¥é”™çš„æ¨¡å—åœ¨ transformIgnorePatterns é‡Œæ’é™¤æ‰ï¼Œå½“ç„¶ä¸€äº›åº“æ¯”å¦‚ axios é¢å¤–æä¾›äº† CommonJS è§„èŒƒçš„ä»£ç ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç›´æ¥è®¾ç½® moduleNameMapper æ¥è§£å†³ã€‚
- https://stackoverflow.com/questions/73958968/cannot-use-import-statement-outside-a-module-with-axios

```
  "jest": {
    "transformIgnorePatterns": [
      "<rootDir>/node_modules/(?!lodash-es)"
    ],
    "moduleNameMapper": {
      "axios": "axios/dist/node/axios.cjs"
    }
  },
```

## äº”ã€ç»„ä»¶åº“è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ

å€ŸåŠ© Storybook + JSDoc æ³¨é‡Š + TypeScript ç±»å‹æç¤ºæ¥å®ç°ç»„ä»¶åº“çš„è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆï¼Œå…·ä½“çš„å®‰è£…åŠé…ç½®å®˜æ–¹æ–‡æ¡£è¯´çš„æ¯”è¾ƒè¯¦ç»†ï¼Œè¿™é‡Œåªä»¥ Select ç»„ä»¶ä¸ºä¾‹ï¼Œæ¥ä»‹ç»ä¸‹ Storybook çš„ä½¿ç”¨ï¼š

```tsx
import type { Meta, StoryObj } from '@storybook/react'
import Select from '.'

const Option = Select.Option

const meta = {
  title: 'Select',
  component: Select,
  tags: ['autodocs'],
  decorators: [
    (Story) => (
      <div style={{ display: 'flex', justifyContent: 'center' }}>
        <div style={{ width: '400px' }}>
          <Story />
        </div>
      </div>
    ),
  ],
} satisfies Meta<typeof Select>

export default meta
type Story = StoryObj<typeof meta>

export const BasicSelect: Story = {
  args: {
    defaultValue: 'second option',
  },
  render: (args) => (
    <Select {...args}>
      <Option value="first option" />
      <Option value="second option" />
      <Option value="third option" disabled />
      <Option value="fourth option" />
    </Select>
  ),
}
```

ä»¥ä¸Šä»£ç ä¼šç”Ÿæˆä¸€ä¸ªåŸºç¡€ Select æ¡†çš„äº¤äº’å¼æ–‡æ¡£ï¼Œæ–‡æ¡£é¦–é¡µä¼šå±•ç¤ºç»„ä»¶å±æ€§ç›¸å…³çš„æè¿°ã€ç±»å‹ã€é»˜è®¤å€¼ç­‰ï¼ŒControls é¢æ¿æ”¯æŒç”¨æˆ·äº¤äº’å¼æ›´æ”¹ç»„ä»¶å±æ€§ï¼ŒActions é¢æ¿ä¼šè®°å½•ç”¨æˆ·äº¤äº’æ‰€è§¦å‘çš„ç»„ä»¶äº‹ä»¶ã€‚

<img src={storybook1} style={{ margin: '0 auto' }} />

<img src={storybook2} style={{ margin: '0 auto' }} />

<img src={storybook3} style={{ zoom: '67%', margin: '0 auto' }} />

## å…­ã€npm æ‰“åŒ…å‘å¸ƒåŠæ–‡æ¡£ç½‘ç«™ CI/CD

é¦–å…ˆå¯¹ä¾èµ–é¡¹è¿›è¡Œç²¾ç®€ï¼Œå°†åªåœ¨å¼€å‘ç¯å¢ƒä¸‹éœ€è¦çš„ä¾èµ–åº“ç§»åŠ¨åˆ° devDependencies ä¸­ï¼Œå‡å°‘å®‰è£…æˆ‘ä»¬ npm åŒ…æ—¶æ‰€è¿å¸¦çš„ä¾èµ–åº“ï¼š

<img src={prev} style={{ zoom: '67%', margin: '0 auto' }} />

<img src={after1} style={{ zoom: '67%', margin: '0 auto' }} />

<img src={after2} style={{ zoom: '67%', margin: '0 auto' }} />

ç„¶åè®¾ç½®æ„å»ºé€‰é¡¹ï¼Œå…¶ä¸­ï¼Œæ ·å¼æ–‡ä»¶çš„ç¼–è¯‘ä½¿ç”¨ node-sassï¼ŒTypeScript çš„æ„å»ºæ—¶ç¼–è¯‘é€‰é¡¹è®¾ç½®å¦‚ä¸‹ï¼š

```
// tsconfig.build.json
{
  "compilerOptions": {
    "outDir": "dist",
    "module": "esnext",
    "target": "es5",
    "declaration": true,
    "jsx": "react",
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true
  },
  "include": [
    "src"
  ],
  "exclude": [
    "src/**/*.test.tsx",
    "src/**/*.stories.tsx",
  ]
}
```

npm åŒ…ç›¸å…³ä¿¡æ¯é…ç½®ï¼š

```
  // package.json
  "name": "russell-react-ui",
  "version": "0.1.2",
  "private": false,
  "description": "A Toy React Components Library Built by TypeScript and Sass",
  "author": "Russellwzr",
  "license": "MIT",
  "keywords": [
    "Component",
    "UI",
    "React"
  ],
  "homepage": "https://github.com/Russellwzr/russell-react-ui",
  "repository": {
    "type": "git",
    "url": "https://github.com/Russellwzr/russell-react-ui"
  },
  "files": [
    "dist"
  ],
  "main": "dist/index.js",
  "module": "dist/index.js",
  "types": "dist/index.d.ts",
```

ä¸å‘å¸ƒç›¸å…³çš„è„šæœ¬è®¾ç½®å¦‚ä¸‹ï¼Œç„¶åç™»å½• npm è´¦å·ï¼Œç›´æ¥è¿è¡Œ npm publish å³å¯ã€‚

```
  // package.json
  "scripts": {
    "clean": "rimraf ./dist",
    "lint": "eslint --ext js,ts,tsx src",
    "build": "npm run clean && npm run build-ts && npm run build-css",
    "test:nowatch": "cross-env CI=true react-scripts test",
    "build-ts": "tsc -p tsconfig.build.json",
    "build-css": "node-sass ./src/styles/index.scss ./dist/index.css",
    "prepublishOnly": "npm run lint && npm run test:nowatch && npm run build",
  },
```

æœ€åä½¿ç”¨ Github Pages éƒ¨ç½²æ–‡æ¡£ç½‘ç«™ï¼Œå€ŸåŠ© Github Actions å®ç° CI/CDï¼Œç›¸å…³å·¥ä½œæµçš„é…ç½®å¦‚ä¸‹ï¼š

```
name: Build and Deploy Storybook Docs
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Install and Build ğŸ”§
        run: |
          npm install
          npm run build-storybook

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          ACCESS_TOKEN: ${{ secrets.RUSSELL_REACT_UI }}
          BRANCH: gh-pages
          FOLDER: storybook-static
```

å…¶ä¸­ï¼Œsecrets.RUSSELL_REACT_UI åœ¨ Repository secrets ä¸­è®¾ç½®ï¼Œä» Developer Settings/Personal access tokens ä¸­ç”Ÿæˆï¼Œæœ€åå†è®¾ç½®ä¸‹å¯¹åº”ä»“åº“çš„ workflow æƒé™å³å¯ã€‚
